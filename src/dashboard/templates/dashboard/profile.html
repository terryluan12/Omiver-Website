{% extends 'dashboard/base.html' %}
{% load static %}
{% load component_tags %}

{% block inner_styles %}
<link rel="stylesheet" href="{% static 'dashboard/profile/style.css' %}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flickity/1.0.0/flickity.css" media="screen">
<script src="https://d3js.org/d3.v7.min.js"></script>
{% endblock %}

{% block dashboard_content %}
<div id="info-block">
    <div class="description-info-block">
        <h4>Hello {{ name }}!</h4>
        <p>Here you can manage your task, set preferences and updates.</p>
    </div>
    <img class="cartoon" src="{% static 'dashboard/profile/banner.svg' %}" />
    <div class="test-info-block">
        <img src="{% static 'dashboard/profile/last_test.svg' %}" />
        <span>
            <h4>Latest Test</h4>
            <p>20 Apr, 2025</p>
        </span>
    </div>
    <div class="test-info-block">
        <img src="{% static 'dashboard/profile/next_test.svg' %}" />
        <span>
            <h4>Next Test</h4>
            <p>21 Apr, 2025</p>
        </span>
    </div>
</div>

<div class="dashboard-container">
    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="action-btn"  onclick="location.href='/demo/select'">
            <span class="btn-icon"><img src="{% static 'dashboard/profile/change_profile.svg' %}" alt="Change Profile" /></span>
            <div class="text-group">
                <span class="btn-text-secondary">Change Profile</span>
                <span class="btn-text">Try other Profiles</span>
            </div>
        </button>
        
        <button class="action-btn" hx-get="/dashboard/chatbot" hx-target="#main-content">
            <span class="btn-icon"><img src="{% static 'dashboard/profile/chatbot.svg' %}" alt="Chatbot" /></span>
            <div class="text-group">
                <span class="btn-text-secondary">Quick Faq Answers</span>
                <span class="btn-text">Interact with Chatbot</span>
            </div>
        </button>
        
        <button class="action-btn" onclick="openNewPage()" hx-get="/improve" hx-target="#main-content">
            <span class="btn-icon"><img src="{% static 'dashboard/profile/improve.svg' %}" alt="Improve" /></span>
            <div class="text-group">
                <span class="btn-text-secondary">Give Feedback</span>
                <span class="btn-text">How we can improve?</span>
            </div>
        </button>
        
        <button class="action-btn" onclick="window.location.href='/#contact-form-response'" hx-get="/support" hx-target="#main-content">
            <span class="btn-icon"><img src="{% static 'dashboard/profile/support.svg' %}" alt="Support" /></span>
            <div class="text-group">
                <span class="btn-text-secondary">Help Center</span>
                <span class="btn-text">Contact & Support</span>
            </div>
        </button>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="main-content">
        <div class="content-grid">
            <!-- Profile Section -->
            <div class="profile-section">
                <div class="profile-header">
                    <h2>Profile</h2>
                </div>
                <div class="profile-card">
                    <div class="profile-info">
                        <div class="profile-top">
                            <div class="profile-avatar">
                                <img class="profile-pic" src="{% static 'demo/select/' %}{{name}}.png" style="border: 3px solid {{ colour }};"/>
                            </div>
                            <div class="profile-basic">
                                <p>{{name}}</p>
                                <p>{{age}} Years Old</p>
                            </div>
                        </div>
                        <div class="profile-stats">
                            <div class="stat">
                                <span class="stat-label">Sex:</span>
                                <span class="stat-value">{{sex}}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Height:</span>
                                <span class="stat-value">{{height}}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Weight:</span>
                                <span class="stat-value">{{weight}}</span>
                            </div>
                        </div>
                        <div class="profile-stats">
                            <div class="stat">
                                <span class="stat-label">Ethnicity:</span>
                                <span class="stat-value">{{ethnicity}}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Allergies:</span>
                                <span class="stat-value">{{allergies}}</span>
                            </div>
                        </div>
                        <div class="profile-stats">
                            <div class="stat">
                                <span class="stat-label">Sport:</span>
                                <span class="stat-value">{{sport}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="profile-image">
                        <img src="{% static 'demo/select/' %}{{name}}.png" alt="Workout">
                    </div>
                </div>
            </div>

            <!-- Highlights Chart -->
            <div class="highlights-section">
                <div class="section-header">
                    <h2>Highlights</h2>
                    <select class="time-filter" hx-get="/highlights" hx-trigger="change" hx-target="#highlights-chart">
                        <option value="7">Last 30 Days</option>
                        <option value="30">Last 60 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                </div>
                <!-- Informational Message -->
                <div class="border border-gray-200 rounded-lg p-4 mb-6 bg-gray-50">
                    <p class="text-gray-600">{{ highlight }}</p>
                </div>
                <!-- Chart -->
                <div id="chart" class="relative"></div>
                <div class="tooltip"></div>
            </div>

            <!-- Goals Section -->
            <div class="goals-section">
                <div class="goal-card fitness-goal">
                    <div class="goal-icon"><img src="{% static 'dashboard/profile/fitness_goal.svg' %}" alt="Fitness Goal" /></div>
                    <div class="goal-content">
                        <h3>Fitness Goal</h3>
                        <p>{{ goal.fitness }}</p>
                    </div>
                </div>
                
                <div class="goal-card nutrition-goal">
                    <div class="goal-icon"><img src="{% static 'dashboard/profile/nutrition_goal.svg' %}" alt="Nutrition Goal" /></div>
                    <div class="goal-content">
                        <h3>Nutrition Goal</h3>
                        <p>{{ goal.nutrition }}</p>
                    </div>
                </div>
            </div>

            <!-- Biomarker Overview -->
            <div class="biomarker-section">
                <div class="biomarker-overview biomarker-card">
                    <div class="pie-section">
                        <div class="pie-chart">
                            <div class="pie-background" id="pieBackground"></div>
                            <div class="pie-inner">
                                <div class="percentage" id="overallPercentage">{{biomarker.overall}}</div>
                                <div class="percentage-label">in range</div>
                            </div>
                        </div>
                    </div>
                    <div class="info-section">
                        <h1>Biomarker Overview</h1>
                        <p class="description">
                            Key biomarkers performance; track levels over time to your training and optimize recovery.
                        </p>
                    </div>
                </div>
                <div class="biomarker-grid">
                    {% for marker, value in biomarkers.items %}
                    <div class="biomarker-item biomarker-card">
                        {% component "custom_slider" min='{{value.min}}' max='{{value.max}}' value='{{value.value}}' marker='{{marker}}' / %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Recommendations -->
            <div class="recommendations-section">
                <div class="recommendation-card">
                    <div class="rec-header">
                        <div class="rec-icon">üçΩÔ∏è</div>
                        <h3>Today Recommendation - Meal Plan</h3>
                    </div>
                    <div class="meal-schedule" hx-get="/meal-plan" hx-trigger="revealed" hx-target="this">
                        {% for type, meal in food_log.items %}
                        <div class="meal-item">
                            <strong>{{ type|capfirst }}:</strong>
                            <p>{{ meal }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="recommendation-card">
                    <div class="rec-header">
                        <div class="rec-icon">üí™</div>
                        <h3>Today Recommendation - Exercise Plan</h3>
                    </div>
                    <div class="exercise-schedule" hx-get="/exercise-plan" hx-trigger="revealed" hx-target="this">
                        <div class="exercise-item">
                            <strong>Warm:</strong>
                            <p>Full-body light circuit, hand-eye coordination training</p>
                        </div>
                        <div class="exercise-item">
                            <strong>Part 1:</strong>
                            <p>HIIT circuit: 3 sets of 10-12 reps</p>
                        </div>
                        <div class="exercise-item">
                            <strong>Break:</strong>
                            <p>Take 10 minutes break and rest</p>
                        </div>
                        <div class="exercise-item">
                            <strong>Part 2:</strong>
                            <p>Jumping jacks with alternating arms: 3 sets of 10-12 reps</p>
                        </div>
                        <div class="exercise-item">
                            <strong>Break:</strong>
                            <p>Take 10 minutes break and rest</p>
                        </div>
                        <div class="exercise-item">
                            <strong>Part 3:</strong>
                            <p>Fast jumps with alternating legs: 3 sets of 10-12 reps</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monitoring Progress -->
            <div class="monitoring-section">
                <h2>Monitoring Progress</h2>
                <p>Previous data were checked for 6 months and have seen improvement in 5 biomarker results</p>
                <div class="progress-timeline" hx-get="/progress-data" hx-trigger="revealed" hx-target="this">
                    <div class="timeline-months">
                        <div class="month-indicator active" data-month="Jan">Jan</div>
                        <div class="month-indicator active" data-month="Feb">Feb</div>
                        <div class="month-indicator active" data-month="Mar">Mar</div>
                        <div class="month-indicator active" data-month="Apr">Apr</div>
                        <div class="month-indicator" data-month="May">May</div>
                        <div class="month-indicator" data-month="Jun">Jun</div>
                        <div class="month-indicator" data-month="Jul">Jul</div>
                        <div class="month-indicator" data-month="Aug">Aug</div>
                        <div class="month-indicator" data-month="Sep">Sep</div>
                        <div class="month-indicator" data-month="Oct">Oct</div>
                        <div class="month-indicator" data-month="Nov">Nov</div>
                        <div class="month-indicator" data-month="Dec">Dec</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const biomarkerData = {};
    function updatePieChart() {
        const average = Object.values(biomarkerData).length > 0 ? Math.round(Object.values(biomarkerData).reduce((a, b) => a + b, 0) / Object.values(biomarkerData).length) : 0;
        const pieBackground = document.getElementById('pieBackground');
        const percentageElement = document.getElementById('overallPercentage');
        
        const angle = (average / 100) * 360;
        pieBackground.style.setProperty('--percentage', `${angle}deg`);
        percentageElement.textContent = `${23}%`;
    }

    // Initialize with default values
    updatePieChart();

    // --- 1. D3 CHART SETUP ---
        const chartData = [
            { date: '2025-12-01', value: 85 },
            { date: '2025-12-05', value: 40 },
            { date: '2025-12-10', value: 80 },
            { date: '2025-12-15', value: 55 },
            { date: '2025-12-20', value: 60 },
            { date: '2025-12-25', value: 10 },
        ];
        
        const parseDate = d3.timeParse("%Y-%m-%d");
        const data = chartData.map(d => ({
            date: parseDate(d.date),
            value: d.value
        }));

        const margin = { top: 20, right: 30, bottom: 40, left: 50 };
        const width = 700 - margin.left - margin.right;
        const height = 350 - margin.top - margin.bottom;

        const svg = d3.select("#chart")
            .append("svg")
            .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
            
        const tooltip = d3.select(".tooltip");

        // --- 2. SCALES ---
        const xScale = d3.scaleTime()
            .domain(d3.extent(data, d => d.date))
            .range([0, width]);

        const yScale = d3.scaleLinear()
            .domain([0, 100]) // Domain from Low (0) to High (100)
            .range([height, 0]);

        // --- 3. AXES ---
        const xAxis = d3.axisBottom(xScale)
            .ticks(data.length)
            .tickFormat(d3.timeFormat("%d-%m\n%Y"));
            
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(xAxis)
            .attr("class", "axis x-axis")
            .selectAll("text")
            .style("text-anchor", "middle")
            .attr("dy", "0.5em");
            
        // Custom Y-axis labels instead of a traditional axis
        const yAxisLabels = [
            { label: "High", value: 90 },
            { label: "Avg.", value: 50 },
            { label: "Low", value: 10 }
        ];

        svg.selectAll(".y-axis-label")
            .data(yAxisLabels)
            .enter()
            .append("text")
            .attr("class", "y-axis-label")
            .attr("x", -10)
            .attr("y", d => yScale(d.value))
            .attr("text-anchor", "end")
            .attr("alignment-baseline", "middle")
            .text(d => d.label);

        // --- 4. DRAWING THE CHART ---
        // Area generator
        const area = d3.area()
            .x(d => xScale(d.date))
            .y0(height)
            .y1(d => yScale(d.value))
            .curve(d3.curveMonotoneX);

        svg.append("path")
            .datum(data)
            .attr("class", "area")
            .attr("d", area);

        // Line generator
        const line = d3.line()
            .x(d => xScale(d.date))
            .y(d => yScale(d.value))
            .curve(d3.curveMonotoneX);

        svg.append("path")
            .datum(data)
            .attr("class", "line")
            .attr("d", line);

        // Data points (dots)
        svg.selectAll(".dot")
            .data(data)
            .enter().append("circle")
            .attr("class", "dot")
            .attr("cx", d => xScale(d.date))
            .attr("cy", d => yScale(d.value))
            .attr("r", 6)
            .on("mouseover", (event, d) => {
                // Show tooltip on hover
                tooltip.style("opacity", 1);
                // Special case for the "High" point as in the image
                if (d.value === 80) {
                    tooltip.html("High");
                } else {
                    tooltip.html(`Value: ${d.value}`);
                }
            })
            .on("mousemove", (event) => {
                // Position the tooltip relative to the chart container
                const [posX, posY] = d3.pointer(event, d3.select("#chart").node());
                tooltip.style("left", `${posX}px`).style("top", `${posY}px`);
            })
            .on("mouseout", () => {
                // Hide tooltip
                tooltip.style("opacity", 0);
            });

            function openNewPage() {
                window.open('https://forms.gle/24t8j5ymXPfJtg577', '_blank');
            }
</script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flickity/1.0.0/flickity.pkgd.js"></script>
{% component "demo_modal" / %}
{% endblock %}